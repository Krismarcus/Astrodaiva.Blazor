@page "/year"
@inject Astrodaiva.Blazor.Services.AstroDbStore Store
@implements IDisposable
@using Astrodaiva.Data.Enums
@using Astrodaiva.Data.Models
@using System.Globalization
@using Astrodaiva.Blazor.Utils

<div class="year-switcher">
    <button class="year-arrow" @onclick="PrevYear">&#8592;</button>
    <span class="year-label">@_year</span>
    <button class="year-arrow" @onclick="NextYear">&#8594;</button>
</div>

<div class="card" @onclick="() => _activeRetroKey = null">
    @if (_db is null)
    {
        <div>Loading astro database…</div>
    }
    else
    {
        <div class="timeline-container">
            <div class="timeline-content">
                <!-- Month labels -->
                <div class="month-labels-container">
                    <div class="planet-label-spacer"></div>
                    <div class="month-bar">
                        @foreach (var month in _monthSegments)
                        {
                            <span class="month-label @(IsMonthHighlighted(month) ? "highlighted" : "")"
                                  style="width:@(month.WidthPercentage)%">
                                @CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(month.MonthStartDate.Month)
                            </span>
                        }
                    </div>
                </div>

                <!-- Planet Rows -->
                @foreach (var planetRow in _planetRows)
                {
                    <div class="planet-row">
                        <div class="planet-label">@planetRow.PlanetName</div>

                        <div class="planet-bar-container">
                            <!-- Main Zodiac Bar -->
                            <div class="year-bar">
                                @foreach (var segment in planetRow.Segments)
                                {
                                    <span class="zodiac-bar @(IsSegmentSelected(planetRow.PlanetName, segment) ? "selected" : "")"
                                          style="background:@Zodiac.Color(segment.ZodiacSign);width:@(segment.WidthPercentage)%"
                                          title="@($"{planetRow.PlanetName}: {Zodiac.Name(segment.ZodiacSign)} {segment.ZodiacStartDate:MMM d} - {segment.ZodiacEndDate:MMM d}")"
                                          @onclick="() => SelectSegment(planetRow.PlanetName, segment)"
                                          @onmouseover="() => OnSegmentHover(segment)"
                                          @onmouseout="OnSegmentHoverOut">

                                        <span class="bar-content">
                                            @if (!(segment.ZodiacStartDate.Month == 1 && segment.ZodiacStartDate.Day == 1))
                                            {
                                                <span class="start-day">@segment.ZodiacStartDate.Day</span>
                                            }
                                            <img class="zodiac-symbol"
                                                 src="@Zodiac.ImagePath(segment.ZodiacSign)"
                                                 alt="@Zodiac.Name(segment.ZodiacSign)" />
                                        </span>
                                    </span>
                                }
                            </div>

                            <!-- Retrograde Bar -->
                            <!-- Retrograde Bar -->
                            <div class="retrograde-bar-container">
                                @foreach (var retroSegment in GetRetrogradeSegments(planetRow.PlanetName))
                                {
                                    var key = MakeRetroKey(planetRow.PlanetName.ToString(), retroSegment.StartDate);
                                    <span class="retrograde-bar @(key == _activeRetroKey ? "is-active" : null)"
                                          style="width:@(retroSegment.WidthPercentage)%; left:@(retroSegment.LeftPosition)%"
                                          title="@($"{planetRow.PlanetName} Retrograde: {retroSegment.StartDate:MMM d} - {retroSegment.EndDate:MMM d}")"
                                          @onpointerdown="@(() => _activeRetroKey = key)"
                                          @onpointerup="@(() => StateHasChanged())"
                                          @onpointercancel="@(() => _activeRetroKey = null)"
                                          @onpointerleave="@(() => _activeRetroKey = null)">
                                        <span class="retro-start-day">@retroSegment.StartDate.Day</span>
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Event Details Panel -->
        @if (_showEventDetails)
        {
            <div class="event-details-panel" @onclick="HideEventDetails">
                <div class="event-details-content" @onclick:stopPropagation="true">
                    <div class="event-details-header">
                        <h3>@_selectedPlanetInZodiacText</h3>
                        <button class="close-button" @onclick="HideEventDetails">&times;</button>
                    </div>
                    <div class="event-dates">
                        <span class="date-range">@_selectedStartDateText</span>
                        <span class="date-range">@_selectedEndDateText</span>
                    </div>
                    <div class="event-info">
                        @_selectedPlanetInfo
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private AppDB? _db;
    private int _year = DateTime.Now.Year;
    private List<PlanetRow> _planetRows = new();
    private List<MonthSegment> _monthSegments = new();
    private bool _showEventDetails = false;
    private string _selectedPlanetInZodiacText = "";
    private string _selectedStartDateText = "";
    private string _selectedEndDateText = "";
    private string _selectedPlanetInfo = "";

    // Selection
    private Planet? _selectedPlanetName;
    private ZodiacSegment? _selectedSegment;

    // Hover
    private ZodiacSegment? _hoveredSegment;

    // Touch "active" retrograde key (planet + start date)
    private string? _activeRetroKey;
    private static string MakeRetroKey(string planetName, DateTime start)
        => $"{planetName}:{start:yyyyMMdd}";

    // Order shown in the UI
    private static readonly Planet[] PlanetsOrder = new[]
    {
        Planet.Sun, Planet.Mercury, Planet.Venus, Planet.Mars, Planet.Jupiter,
        Planet.Saturn, Planet.Uranus, Planet.Neptune, Planet.Pluto,
        Planet.Selena, Planet.Lilith, Planet.Rahu, Planet.Ketu
    };

    protected override async Task OnInitializedAsync()
    {
        Store.Changed += OnStoreChanged;
        _db = await Store.EnsureLoadedAsync();
        GenerateCalendar();
    }

    private void OnStoreChanged()
    {
        _db = Store.Db;
        ClearSelection();
        GenerateCalendar();
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Store.Changed -= OnStoreChanged;
    }

    private void PrevYear()
    {
        _year--;
        ClearSelection();
        GenerateCalendar();
        StateHasChanged();
    }

    private void NextYear()
    {
        _year++;
        ClearSelection();
        GenerateCalendar();
        StateHasChanged();
    }

    private void SelectSegment(Planet planetName, ZodiacSegment segment)
    {
        if (segment == null) return;

        if (_selectedPlanetName == planetName && AreSegmentsEqual(_selectedSegment, segment))
        {
            ClearSelection();
            StateHasChanged();
            return;
        }

        var infoSourceItem = _db?.PlanetInZodiacsDB?.FirstOrDefault(p =>
            p.Planet == planetName && p.ZodiacSign == segment.ZodiacSign);

        _selectedPlanetInZodiacText = $"{planetName} in {Zodiac.Name(segment.ZodiacSign)}";
        _selectedStartDateText = $"From {segment.ZodiacStartDate:MMMM d, HH:mm}";
        _selectedEndDateText = $"To {segment.ZodiacEndDate:MMMM d, HH:mm}";
        _selectedPlanetInfo = infoSourceItem?.PlanetInZodiacInfo ?? "No information available.";

        _selectedPlanetName = planetName;
        _selectedSegment = segment;
        _showEventDetails = true;
        _activeRetroKey = null;
        StateHasChanged();
    }

    private void OnSegmentHover(ZodiacSegment segment)
    {
        _hoveredSegment = segment;
        StateHasChanged();
    }

    private void OnSegmentHoverOut()
    {
        _hoveredSegment = null;
        StateHasChanged();
    }

    private bool IsMonthHighlighted(MonthSegment month)
    {
        if (_hoveredSegment == null) return false;

        return _hoveredSegment.ZodiacStartDate <= month.MonthEndDate &&
               _hoveredSegment.ZodiacEndDate >= month.MonthStartDate;
    }

    private List<RetrogradeSegment> GetRetrogradeSegments(Planet planet)
    {
        var segments = new List<RetrogradeSegment>();
        var activeAstroEvents = _db?.AstroEventsDB?
            .Where(e => e.Date.Year == _year)
            .OrderBy(e => e.Date)
            .ToList();

        if (activeAstroEvents == null || activeAstroEvents.Count == 0)
            return segments;

        bool? lastRetrograde = null;
        DateTime? startDate = null;

        foreach (var astroEvent in activeAstroEvents)
        {
            bool? current = GetPlanetRetrogradeState(astroEvent, planet);
            if (current == null) continue;

            if (lastRetrograde == null || current != lastRetrograde)
            {
                if (startDate != null && lastRetrograde == true)
                {
                    segments.Add(CreateRetrogradeSegment(startDate.Value, astroEvent.Date.AddDays(-1)));
                }

                if (current == true)
                    startDate = astroEvent.Date;

                lastRetrograde = current;
            }
        }

        if (startDate != null && lastRetrograde == true)
        {
            var lastEvent = activeAstroEvents.Last();
            segments.Add(CreateRetrogradeSegment(startDate.Value, lastEvent.Date));
        }

        return segments;
    }

    private RetrogradeSegment CreateRetrogradeSegment(DateTime startDate, DateTime endDate)
    {
        var startOfYear = new DateTime(_year, 1, 1);
        var daysFromStart = (startDate - startOfYear).Days;
        var duration = (endDate - startDate).Days + 1;

        var leftPosition = (daysFromStart * 100.0) / 365;
        var widthPercentage = (duration * 100.0) / 365;

        return new RetrogradeSegment
        {
            StartDate = startDate,
            EndDate = endDate,
            WidthPercentage = widthPercentage,
            LeftPosition = leftPosition
        };
    }

    private bool? GetPlanetRetrogradeState(AstroEvent e, Planet planet) => planet switch
    {
        Planet.Mercury => e.MercuryInZodiac?.IsRetrograde,
        Planet.Venus => e.VenusInZodiac?.IsRetrograde,
        Planet.Mars => e.MarsInZodiac?.IsRetrograde,
        Planet.Jupiter => e.JupiterInZodiac?.IsRetrograde,
        Planet.Saturn => e.SaturnInZodiac?.IsRetrograde,
        Planet.Uranus => e.UranusInZodiac?.IsRetrograde,
        Planet.Neptune => e.NeptuneInZodiac?.IsRetrograde,
        Planet.Pluto => e.PlutoInZodiac?.IsRetrograde,
        _ => null // Sun/Nodes/Selena/Lilith usually not used for retrograde bars
    };

    private void HideEventDetails()
    {
        _showEventDetails = false;
        _activeRetroKey = null;
        StateHasChanged();
    }

    private bool IsSegmentSelected(Planet planetName, ZodiacSegment segment)
        => _selectedPlanetName == planetName && AreSegmentsEqual(_selectedSegment, segment);

    private static bool AreSegmentsEqual(ZodiacSegment? a, ZodiacSegment? b)
        => a is not null && b is not null
           && a.ZodiacSign == b.ZodiacSign
           && a.ZodiacStartDate == b.ZodiacStartDate
           && a.ZodiacEndDate == b.ZodiacEndDate;

    private void ClearSelection()
    {
        _showEventDetails = false;
        _selectedPlanetName = null;
        _selectedSegment = null;
        _selectedPlanetInZodiacText = "";
        _selectedStartDateText = "";
        _selectedEndDateText = "";
        _selectedPlanetInfo = "";
        _hoveredSegment = null;
        _activeRetroKey = null;
    }

    private void GenerateCalendar()
    {
        _planetRows.Clear();
        _monthSegments.Clear();

        var events = _db?.AstroEventsDB?
            .Where(e => e.Date.Year == _year)
            .OrderBy(e => e.Date)
            .ToList();

        if (events == null || events.Count == 0) return;

        GenerateMonthSegments(events);
        GeneratePlanetSegments(events);
    }

    private void GenerateMonthSegments(List<AstroEvent> events)
    {
        var lastEvent = events.Last();

        for (int month = 1; month <= 12; month++)
        {
            var monthStart = new DateTime(_year, month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);

            if (monthStart > lastEvent.Date) break;
            if (monthEnd > lastEvent.Date) monthEnd = lastEvent.Date;

            var daysInMonth = (monthEnd - monthStart).Days + 1;
            var width = (daysInMonth * 100.0) / 365;

            _monthSegments.Add(new MonthSegment
            {
                MonthStartDate = monthStart,
                MonthEndDate = monthEnd,
                WidthPercentage = width
            });
        }
    }

    private void GeneratePlanetSegments(List<AstroEvent> events)
    {
        foreach (var planet in PlanetsOrder)
        {
            var segments = BuildPlanetSegments(events, planet);
            _planetRows.Add(new PlanetRow { PlanetName = planet, Segments = segments });
        }
    }

    private List<ZodiacSegment> BuildPlanetSegments(List<AstroEvent> events, Planet planet)
    {
        var segments = new List<ZodiacSegment>();
        ZodiacSign? lastSign = null;
        DateTime? startDate = null;

        foreach (var e in events)
        {
            var current = GetPlanetZodiacSign(e, planet);
            if (current == null) continue;

            if (lastSign == null || current != lastSign)
            {
                if (startDate != null && lastSign != null)
                    segments.Add(CreateZodiacSegment(lastSign.Value, startDate.Value, e.Date.AddDays(-1)));

                startDate = e.Date;
                lastSign = current;
            }
        }

        if (startDate != null && lastSign != null)
        {
            var lastEvent = events.Last();
            segments.Add(CreateZodiacSegment(lastSign.Value, startDate.Value, lastEvent.Date));
        }

        return segments;
    }

    private static ZodiacSegment CreateZodiacSegment(ZodiacSign sign, DateTime start, DateTime end)
    {
        var duration = (end - start).Days + 1;
        var width = (duration * 100.0) / 365;

        return new ZodiacSegment
        {
            ZodiacSign = sign,
            ZodiacStartDate = start,
            ZodiacEndDate = end,
            Duration = duration,
            WidthPercentage = width
        };
    }

    private static ZodiacSign? GetPlanetZodiacSign(AstroEvent e, Planet planet) => planet switch
    {
        Planet.Sun => e.SunInZodiac?.NewZodiacSign,
        Planet.Mercury => e.MercuryInZodiac?.NewZodiacSign,
        Planet.Venus => e.VenusInZodiac?.NewZodiacSign,
        Planet.Mars => e.MarsInZodiac?.NewZodiacSign,
        Planet.Jupiter => e.JupiterInZodiac?.NewZodiacSign,
        Planet.Saturn => e.SaturnInZodiac?.NewZodiacSign,
        Planet.Uranus => e.UranusInZodiac?.NewZodiacSign,
        Planet.Neptune => e.NeptuneInZodiac?.NewZodiacSign,
        Planet.Pluto => e.PlutoInZodiac?.NewZodiacSign,
        Planet.Selena => e.SelenaInZodiac?.NewZodiacSign,
        Planet.Lilith => e.LilithInZodiac?.NewZodiacSign,
        Planet.Rahu => e.RahuInZodiac?.NewZodiacSign,
        Planet.Ketu => e.KetuInZodiac?.NewZodiacSign,
        _ => null
    };

    // Helper classes
    public class PlanetRow
    {
        public Planet PlanetName { get; set; }
        public List<ZodiacSegment> Segments { get; set; } = new();
    }

    public class MonthSegment
    {
        public DateTime MonthStartDate { get; set; }
        public DateTime MonthEndDate { get; set; }
        public double WidthPercentage { get; set; }
    }

    public class ZodiacSegment
    {
        public ZodiacSign ZodiacSign { get; set; }
        public DateTime ZodiacStartDate { get; set; }
        public DateTime ZodiacEndDate { get; set; }
        public int Duration { get; set; }
        public double WidthPercentage { get; set; }
    }

    public class RetrogradeSegment
    {
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public double WidthPercentage { get; set; }
        public double LeftPosition { get; set; }
    }
}


<style>
    .timeline-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow-x: auto; /* mobile: allow horizontal scroll */
        -webkit-overflow-scrolling: touch;
    }

    .timeline-content {
        min-width: 1440px; /* MOBILE: doubled from 720px to 1440px */
    }

    .month-labels-container {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }

    .planet-label-spacer {
        width: 80px;
        margin-right: 1em;
        flex-shrink: 0;
    }

    .month-bar {
        display: flex;
        height: 24px;
        flex: 1;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        background: #f8f8f8;
        box-shadow: 0 1px 2px #0001;
        min-width: 1360px; /* 1440px - 80px (spacer width) */
    }

    .month-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95em;
        color: #444;
        font-weight: 500;
        border-right: 1px solid #eee;
        background: #f8f8f8;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }

        .month-label.highlighted {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
            box-shadow: inset 0 0 0 2px #1976d2;
        }

        .month-label:last-child {
            border-right: none;
        }

    .planet-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.75em;
    }

    .planet-label {
        width: 80px;
        font-weight: bold;
        text-align: right;
        padding-right: 1em;
        color: #333;
        flex-shrink: 0;
    }

    .planet-bar-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        min-width: 1360px; /* 1440px - 80px (label width) */
    }

    .year-bar {
        display: flex;
        height: 32px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 4px #0002;
    }

    /* Retrograde line: thin by default */
    .retrograde-bar-container {
        position: relative;
        height: 4px;
        margin-top: 2px;
        overflow: visible; /* allow hover growth to overflow */
    }

    .retrograde-bar {
        position: absolute;
        height: 100%;
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border-radius: 2px;
        opacity: 0.85;
        transform-origin: center;
        transform: translateY(0) scaleY(1);
        transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
    }

    /* start-day on retrograde: hidden by default */
    .retro-start-day {
        position: absolute;
        left: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,.6);
        letter-spacing: .2px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 120ms ease;
    }

    /* Desktop: hover shows label and thickens line */
    @@media (hover: hover) {
        .retrograde-bar:hover {
            transform: translateY(-6px) scaleY(4); /* ~16px visual thickness */
            filter: brightness(1.08);
            box-shadow: 0 2px 10px rgba(0,0,0,.25);
        }

            .retrograde-bar:hover .retro-start-day {
                opacity: 1;
            }
    }

    /* Touch devices: tap to activate (class comes from pointer handlers) */
    @@media (hover: none) {
        .retrograde-bar.is-active {
            transform: translateY(-6px) scaleY(4);
            filter: brightness(1.08);
            box-shadow: 0 2px 10px rgba(0,0,0,.25);
        }

            .retrograde-bar.is-active .retro-start-day {
                opacity: 1;
            }
    }

    .zodiac-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #222;
        font-size: 0.9em;
        font-weight: 500;
        white-space: nowrap;
        border-right: 1px solid #fff3;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        overflow: hidden;
    }

    .bar-content {
        display: flex;
        align-items: center;
        width: 100%;
        height: 100%;
        padding: 0 8px;
        position: relative;
    }

    .start-day {
        font-size: 0.95em;
        font-weight: 500;
        color: #444;
        white-space: nowrap;
        position: absolute;
        left: 8px;
        z-index: 2;
    }

    .zodiac-symbol {
        height: 20px;
        width: 20px;
        object-fit: contain;
        margin: 0 auto;
    }

    .zodiac-bar:last-child {
        border-right: none;
    }

    .zodiac-bar.selected {
        border: 3px solid #000 !important;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        z-index: 10;
        transform: scale(1.02);
    }

    .zodiac-bar:hover {
        filter: brightness(1.2);
        transform: scale(1.02);
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
        z-index: 5;
    }

    .event-details-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        height: 100vh;
    }

    .event-details-content {
        background: white;
        border-radius: 16px 16px 0 0;
        padding: 20px;
        width: 100%;
        max-width: 600px;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* mobile notch safe area */
    }

    .event-details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

        .event-details-header h3 {
            margin: 0;
            color: #333;
        }

    .close-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .event-dates {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 15px;
    }

    .date-range {
        font-size: 0.9em;
        color: #666;
    }

    .event-info {
        line-height: 1.5;
        color: #333;
    }

    .year-switcher {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1em;
        gap: 1em;
    }

    .year-label {
        font-size: 1.5em;
        font-weight: bold;
        margin: 0 1em;
        vertical-align: middle;
    }

    .year-arrow {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #666;
        padding: 0 0.5em;
        vertical-align: middle;
        width: 44px;
        height: 44px; /* nicer on touch */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
    }

        .year-arrow:focus {
            outline: none;
        }

    /* Narrow layouts: keep things readable via horizontal scroll */
    @@media (max-width: 820px) {
        .planet-label-spacer, .planet-label {
            width: 56px;
        }

        .month-bar {
            height: 22px;
            min-width: 1384px; /* 1440px - 56px */
        }

        .planet-bar-container {
            min-width: 1384px; /* 1440px - 56px */
        }

        .year-bar {
            height: 28px;
        }
    }

    @@media (max-width: 800px) {
        .planet-label-spacer, .planet-label {
            width: 80px;
            font-size: .8rem;
        }

        .month-bar {
            min-width: 1360px; /* 1440px - 80px */
        }

        .planet-bar-container {
            min-width: 1360px; /* 1440px - 80px */
        }

        .bar-content {
            padding: 0 6px;
        }

        .start-day {
            left: 6px;
            font-size: .85rem;
        }

        .zodiac-symbol {
            height: 16px;
            width: 16px;
        }

        .month-label {
            font-size: .8rem;
        }
    }
</style>
